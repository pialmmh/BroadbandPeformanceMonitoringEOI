<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>BPMN: Run Speed Test</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Inter', sans-serif; background: #f5f5f5; padding: 20px; }
    .a4-container { width: 700px; margin: 0 auto; background: #fff; padding: 48px; border: 1px solid #ccc; }
    h1 { color: #1e3a5f; margin-bottom: 16px; font-size: 18px; }
    .bpmn-diagram { position: relative; border: 1px solid #ddd; overflow: hidden; }
    .connections-layer { position: absolute; top: 0; left: 0; pointer-events: none; z-index: 5; }
    .swim-lane { display: flex; border-bottom: 1px solid #ccc; margin: 10px 0; overflow: hidden; }
    .swim-lane:last-child { border-bottom: none; }
    .lane-header { width: 50px; min-width: 50px; color: white; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 9px; text-align: center; line-height: 1.2; }
    .lane-content { flex: 1; position: relative; background: #fafafa; }
    .bpmn-node { position: absolute; transform: translate(-50%, -50%); z-index: 10; }
    .bpmn-start { width: 24px; height: 24px; border-radius: 50%; border: 2px solid #22c55e; background: #fff; }
    .bpmn-end { width: 24px; height: 24px; border-radius: 50%; border: 4px solid #dc2626; background: #fff; }
    .bpmn-message-catch { width: 26px; height: 26px; border-radius: 50%; border: 1.5px solid #475569; background: #fff; display: flex; align-items: center; justify-content: center; }
    .bpmn-message-catch svg { width: 14px; height: 11px; }
    .bpmn-task, .bpmn-subprocess { padding: 3px 5px; width: 68px; max-height: 60px; text-align: center; border: 2px solid; overflow: hidden; }
    .bpmn-task { background: #dbeafe; border-color: #2563eb; }
    .bpmn-subprocess { background: #fef3c7; border-color: #d97706; }
    .task-num { font-size: 11px; font-weight: 700; color: #1e3a5f; display: block; }
    .task-name { font-size: 9px; color: #1f2937; line-height: 1.1; }
    .bpmn-gateway { width: 22px; height: 22px; background: #f3e8ff; border: 2px solid #7c3aed; transform: translate(-50%, -50%) rotate(45deg); display: flex; align-items: center; justify-content: center; }
    .bpmn-gateway span { transform: rotate(-45deg); font-size: 10px; font-weight: bold; color: #7c3aed; }
    .legend { margin-top: 12px; padding: 8px; background: #f9f9f9; border: 1px solid #ddd; display: flex; gap: 12px; flex-wrap: wrap; font-size: 9px; }
    .legend-item { display: flex; align-items: center; gap: 4px; }
    .legend-icon { width: 14px; height: 14px; }
    .legend-start { border-radius: 50%; border: 2px solid #22c55e; background: #fff; }
    .legend-end { border-radius: 50%; border: 3px solid #dc2626; background: #fff; }
    .legend-task { background: #dbeafe; border: 1px solid #2563eb; }
    .legend-line { width: 20px; height: 2px; background: #475569; }
    .legend-line-dash { width: 20px; border-top: 1px dashed #888; }
    .footer { margin-top: 8px; font-size: 9px; font-style: italic; color: #6b7280; text-align: center; }
    table { width: 100%; border-collapse: collapse; margin-top: 16px; font-size: 10px; }
    th, td { border: 1px solid #ddd; padding: 4px 6px; text-align: left; }
    th { background: #1e3a5f; color: white; }
  </style>
</head>
<body>

<div class="a4-container">
  <h1>Process: Run Speed Test</h1>
  <div id="diagram" class="bpmn-diagram"></div>
  <div class="legend">
    <div class="legend-item"><div class="legend-icon legend-start"></div>Start</div>
    <div class="legend-item"><div class="legend-icon legend-end"></div>End</div>
    <div class="legend-item"><div class="legend-icon legend-task">N</div>Task</div>
    <div class="legend-item"><div class="legend-line"></div>Sequence</div>
    <div class="legend-item"><div class="legend-line-dash"></div>Message</div>
  </div>
  <table>
    <tr><th>#</th><th>Task</th><th>Lane</th><th>Type</th><th>Use Case</th></tr>
    <tr><td>1</td><td>Select Server</td><td>End User</td><td>task</td><td>UC010</td></tr><tr><td>2</td><td>Run Download Test</td><td>System</td><td>task</td><td>UC010</td></tr><tr><td>3</td><td>Run Upload Test</td><td>System</td><td>task</td><td>UC010</td></tr><tr><td>4</td><td>Calculate Metrics</td><td>System</td><td>task</td><td>UC010</td></tr><tr><td>5</td><td>Display Results</td><td>System</td><td>task</td><td>UC011</td></tr><tr><td>6</td><td>Save Results</td><td>System</td><td>task</td><td>UC012</td></tr>
  </table>
  <div class="footer">Generated from requirements-matrix.xlsx</div>
</div>

<script>
const LANE_COLORS = [
  { bg: '#2563eb', text: '#fff' },
  { bg: '#059669', text: '#fff' },
  { bg: '#d97706', text: '#fff' }
];
const PAGE_WIDTH = 604;
const LANE_HEADER_WIDTH = 50;
const LANE_CONTENT_WIDTH = PAGE_WIDTH - LANE_HEADER_WIDTH;
const LANE_HEIGHT = 80;
const LANE_MARGIN = 10;

const processData = {
  "lanes": [
    {
      "id": "end-user",
      "name": "End<br>User"
    },
    {
      "id": "system",
      "name": "System"
    }
  ],
  "nodes": [
    {
      "id": "start",
      "type": "start",
      "lane": "end-user",
      "x": 5
    },
    {
      "id": "t1",
      "type": "task",
      "lane": "end-user",
      "x": 15,
      "num": "1",
      "name": "Select<br>Server"
    },
    {
      "id": "t2",
      "type": "task",
      "lane": "system",
      "x": 15,
      "num": "2",
      "name": "Run Download<br>Test"
    },
    {
      "id": "t3",
      "type": "task",
      "lane": "system",
      "x": 29,
      "num": "3",
      "name": "Run Upload<br>Test"
    },
    {
      "id": "t4",
      "type": "task",
      "lane": "system",
      "x": 43,
      "num": "4",
      "name": "Calculate<br>Metrics"
    },
    {
      "id": "t5",
      "type": "task",
      "lane": "system",
      "x": 57,
      "num": "5",
      "name": "Display<br>Results"
    },
    {
      "id": "t6",
      "type": "task",
      "lane": "system",
      "x": 71,
      "num": "6",
      "name": "Save<br>Results"
    },
    {
      "id": "end",
      "type": "end",
      "lane": "end-user",
      "x": 95
    }
  ],
  "connections": [
    {
      "from": "start",
      "to": "t1",
      "type": "sequence"
    },
    {
      "from": "t1",
      "to": "end",
      "type": "sequence"
    },
    {
      "from": "t2",
      "to": "t3",
      "type": "sequence"
    },
    {
      "from": "t3",
      "to": "t4",
      "type": "sequence"
    },
    {
      "from": "t4",
      "to": "t5",
      "type": "sequence"
    },
    {
      "from": "t5",
      "to": "t6",
      "type": "sequence"
    }
  ]
};

class BpmnRenderer {
  constructor(containerId) {
    this.container = document.getElementById(containerId);
    this.positions = {};
  }

  render(data) {
    const { lanes, nodes, connections } = data;
    const totalHeight = lanes.length * (LANE_HEIGHT + LANE_MARGIN * 2);

    let html = `<svg class="connections-layer" width="${PAGE_WIDTH}" height="${totalHeight}"></svg>`;

    lanes.forEach((lane, idx) => {
      const color = LANE_COLORS[idx % LANE_COLORS.length];
      html += `<div class="swim-lane" style="height:${LANE_HEIGHT}px">
        <div class="lane-header" style="background:${color.bg};color:${color.text}">${lane.name}</div>
        <div class="lane-content"></div>
      </div>`;
    });

    this.container.innerHTML = html;
    this.container.style.width = PAGE_WIDTH + 'px';

    const laneContents = this.container.querySelectorAll('.lane-content');
    nodes.forEach(node => {
      const laneIdx = lanes.findIndex(l => l.id === node.lane);
      if (laneIdx < 0) return;
      const el = this.createNode(node);
      laneContents[laneIdx].appendChild(el);

      const xPx = (node.x / 100) * LANE_CONTENT_WIDTH;
      this.positions[node.id] = {
        x: LANE_HEADER_WIDTH + xPx,
        y: laneIdx * (LANE_HEIGHT + LANE_MARGIN * 2) + LANE_MARGIN + LANE_HEIGHT / 2,
        laneIdx, el
      };
    });

    requestAnimationFrame(() => this.drawConnections(connections));
  }

  createNode(node) {
    const el = document.createElement('div');
    el.className = 'bpmn-node';
    el.style.left = node.x + '%';
    el.style.top = '50%';

    switch (node.type) {
      case 'start':
        el.classList.add('bpmn-start');
        break;
      case 'end':
        el.classList.add('bpmn-end');
        break;
      case 'task':
        el.classList.add('bpmn-task');
        el.innerHTML = `<span class="task-num">${node.num}</span><span class="task-name">${node.name}</span>`;
        break;
      case 'subprocess':
        el.classList.add('bpmn-subprocess');
        el.innerHTML = `<span class="task-num">${node.num}</span><span class="task-name">${node.name}</span>`;
        break;
      case 'message-catch':
        el.classList.add('bpmn-message-catch');
        el.innerHTML = `<svg viewBox="0 0 24 18" fill="none" stroke="#475569" stroke-width="2"><rect x="1" y="1" width="22" height="16" rx="1"/><path d="M1 1 L12 10 L23 1"/></svg>`;
        break;
      case 'gateway-xor':
        el.classList.add('bpmn-gateway');
        el.innerHTML = '<span>X</span>';
        break;
    }
    return el;
  }

  drawConnections(connections) {
    const svg = this.container.querySelector('.connections-layer');
    let content = `<defs>
      <marker id="arr-s" markerWidth="8" markerHeight="6" refX="7" refY="3" orient="auto">
        <polygon points="0 0,8 3,0 6" fill="#475569"/>
      </marker>
      <marker id="arr-m" markerWidth="6" markerHeight="5" refX="5" refY="2.5" orient="auto">
        <polygon points="0 0,6 2.5,0 5" fill="#888"/>
      </marker>
    </defs>`;

    connections.forEach(c => {
      const from = this.positions[c.from];
      const to = this.positions[c.to];
      if (!from || !to) return;

      const fromW = from.el.offsetWidth / 2;
      const toW = to.el.offsetWidth / 2;
      const fromH = from.el.offsetHeight / 2;
      const toH = to.el.offsetHeight / 2;

      if (c.type === 'sequence') {
        const x1 = from.x + fromW, y1 = from.y;
        const x2 = to.x - toW, y2 = to.y;
        let path;
        if (Math.abs(y1 - y2) < 2) {
          path = `M${x1},${y1} L${x2},${y2}`;
        } else {
          const midX = x1 + 12;
          path = `M${x1},${y1} H${midX} V${y2} H${x2}`;
        }
        content += `<path d="${path}" stroke="#475569" stroke-width="1.5" fill="none" marker-end="url(#arr-s)"/>`;
      } else {
        const goDown = from.laneIdx < to.laneIdx;
        const x1 = from.x, y1 = goDown ? from.y + fromH : from.y - fromH;
        const x2 = to.x, y2 = goDown ? to.y - toH : to.y + toH;
        let path;
        if (Math.abs(x1 - x2) < 3) {
          path = `M${x1},${y1} V${y2}`;
        } else {
          const midY = (y1 + y2) / 2;
          path = `M${x1},${y1} V${midY} H${x2} V${y2}`;
        }
        content += `<path d="${path}" stroke="#888" stroke-width="1" stroke-dasharray="4,2" fill="none" marker-end="url(#arr-m)"/>`;
      }
    });

    svg.innerHTML = content;
  }
}

new BpmnRenderer('diagram').render(processData);
</script>
</body>
</html>