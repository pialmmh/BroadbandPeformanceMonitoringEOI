<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BPMN: Onboard Partner ISP</title>
  <link rel="stylesheet" href="../../template/bpmn-styles.css">
</head>
<body>

  <!-- Main Process Container -->
  <div id="main-process"></div>

  <!-- Sub-Process Container -->
  <div class="page-break">--- Page Break ---</div>
  <div id="subprocess-1"></div>

  <script>
    /**
     * Process Data (mirrors YAML structure)
     * Edit this data to update the diagram
     */
    const mainProcess = {
      process: {
        id: "onboard-partner-isp",
        name: "Onboard Partner ISP"
      },
      lanes: [
        { id: "isp", name: "ISP" },
        { id: "btrc-admin", name: "BTRC Admin" },
        { id: "system", name: "System" }
      ],
      // Elements grouped by lane, in display order
      laneElements: {
        "isp": [
          { type: "start" },
          { type: "subprocess", num: "1", name: "Register to BTRC Portal", msgDown: true },
          { type: "message-catch" },  // receives from System (arrow drawn at sender)
          { type: "task", num: "3", name: "Configure API Access" },
          { type: "end" }
        ],
        "btrc-admin": [
          { type: "spacer", width: 48 },
          { type: "message-catch" },  // receives from ISP
          { type: "task", num: "1.A", name: "Review Application" },
          { type: "gateway-xor", msgDown: true }
        ],
        "system": [
          { type: "spacer", width: 175 },
          { type: "message-catch" },  // receives from BTRC Admin
          { type: "task", num: "2", name: "Generate Credentials", msgUp: true },  // sends UP to ISP
          { type: "task", num: "3.A", name: "Create API Keys" }
        ]
      }
    };

    const subprocess1 = {
      process: {
        id: "register-to-btrc-portal",
        name: "Register to BTRC Portal",
        breadcrumb: "Processes > Onboard Partner ISP > <strong>1. Register to BTRC Portal</strong>",
        title: "Sub-Process 1: Register to BTRC Portal"
      },
      lanes: [
        { id: "isp", name: "ISP" },
        { id: "system", name: "System" }
      ],
      laneElements: {
        "isp": [
          { type: "start" },
          { type: "task", num: "1.1", name: "Fill Company Information", msgDown: true },
          { type: "task", num: "1.2", name: "Upload NID & Documents", msgDown: true },
          { type: "message-catch" },  // receives OTP from System (arrow at sender)
          { type: "task", num: "1.3", name: "Enter OTP Code", msgDown: true },
          { type: "end" }
        ],
        "system": [
          { type: "spacer", width: 48 },
          { type: "message-catch" },  // receives form
          { type: "task", num: "1.1.A", name: "Validate Form Data" },
          { type: "message-catch" },  // receives docs
          { type: "task", num: "1.2.A", name: "Verify NID via API" },
          { type: "task", num: "1.2.B", name: "Send OTP", msgUp: true },  // sends UP to ISP
          { type: "message-catch" },  // receives OTP entry
          { type: "task", num: "1.3.A", name: "Verify OTP" }
        ]
      }
    };

    /**
     * Render a BPMN process
     */
    function renderProcess(data, containerId) {
      const container = document.getElementById(containerId);
      const { process, lanes, laneElements } = data;

      let html = `
        <div class="a4-container">
          <div class="breadcrumb">${process.breadcrumb || `Processes > <strong>${process.name}</strong>`}</div>
          <h1>${process.title || `Process: ${process.name}`}</h1>
          <div class="bpmn-container">
      `;

      lanes.forEach(lane => {
        html += renderLane(lane, laneElements[lane.id]);
      });

      html += `
          </div>
          ${renderLegend()}
        </div>
      `;

      container.innerHTML = html;
    }

    function renderLane(lane, elements) {
      let html = `
        <div class="swim-lane">
          <div class="lane-header">${lane.name.replace(' ', '<br>')}</div>
          <div class="lane-content">
      `;

      elements.forEach((el, idx) => {
        // Add flow arrow before element (except first, spacers, and message-catch)
        if (idx > 0 && el.type !== 'spacer' && el.type !== 'message-catch') {
          html += '<div class="flow"></div>';
        }

        // Handle spacers
        if (el.type === 'spacer') {
          html += `<div class="spacer" style="width: ${el.width}px;"></div>`;
          return;
        }

        // Wrap if has message flow
        const hasFlow = el.msgDown || el.msgUp;
        if (hasFlow) {
          html += '<div class="element-with-flow">';
        }

        // Render element
        html += renderElement(el);

        // Message flow indicators - height reaches to lane boundary
        // Lane content has 15px padding + element is centered, so ~28px to border
        if (el.msgDown) {
          html += '<div class="message-flow-down" style="height: 28px; top: 100%;"></div>';
        }
        if (el.msgUp) {
          html += '<div class="message-flow-up" style="height: 28px; bottom: 100%;"></div>';
        }

        if (hasFlow) {
          html += '</div>';
        }

        // Flow after message-catch
        if (el.type === 'message-catch' && idx < elements.length - 1) {
          html += '<div class="flow"></div>';
        }
      });

      html += `
          </div>
        </div>
      `;

      return html;
    }

    function renderElement(el) {
      const nameHtml = el.name ? el.name.replace(/ /g, '<br>') : '';

      switch (el.type) {
        case 'start':
          return '<div class="bpmn-start"></div>';
        case 'end':
          return '<div class="bpmn-end"></div>';
        case 'task':
          return `<div class="bpmn-task"><span class="task-num">${el.num}</span>${nameHtml}</div>`;
        case 'subprocess':
          return `<div class="bpmn-subprocess" onclick="document.getElementById('subprocess-1').scrollIntoView({behavior:'smooth'})"><span class="task-num">${el.num}</span>${nameHtml}</div>`;
        case 'message-catch':
          return '<div class="bpmn-message-catch"></div>';
        case 'gateway-xor':
          return '<div class="bpmn-gateway"><span>X</span></div>';
        case 'gateway-and':
          return '<div class="bpmn-gateway"><span>+</span></div>';
        default:
          return '';
      }
    }

    function renderLegend() {
      return `
        <div class="legend">
          <div class="legend-item"><div class="bpmn-start"></div>Start</div>
          <div class="legend-item"><div class="bpmn-end"></div>End</div>
          <div class="legend-item"><div class="bpmn-task">N</div>Task</div>
          <div class="legend-item"><div class="bpmn-subprocess">N</div>Sub-Process</div>
          <div class="legend-item"><div class="bpmn-message-catch"></div>Receive</div>
          <div class="legend-item"><div class="bpmn-gateway"><span>X</span></div>XOR</div>
          <div class="legend-item"><div class="flow"></div>Flow</div>
          <div class="legend-item"><div class="msg-flow-sample"></div>Message</div>
        </div>
      `;
    }

    // Render diagrams
    renderProcess(mainProcess, 'main-process');
    renderProcess(subprocess1, 'subprocess-1');
  </script>

</body>
</html>
